---
title: "MainProjDBH"
author: "PetraGuy"
date: "11 January 2018"
output: pdf_document
---

```{r setup, include=FALSE}
knitr::opts_chunk$set(echo = FALSE)
library(dplyr)
#library(plyr)
library(ggplot2)
library(gridExtra) # for the ggplots created in for loops
```



```{r, echo = FALSE}
#clear the workspace
rm(list = ls())
cat("\014")
```
```{r}
#to generate plot of a site

PlotSite = function(i){
  Site = DBH_Yr2_agg %>% filter(SITE == i)
  Plotname = paste("Site", i, sep = "")
  Plot = ggplot(data = Site, aes(x = DBH_class, y = Count)) +
    geom_bar(stat = "identity", col = "black", fill = "green") +
    scale_x_continuous("DBH class",
      breaks = 1:20,
      labels = c(1:20),
      limits = c(0, 20))+
    facet_wrap(~PLOT)
  labs(title = Plotname)#+
  #theme(axis.ticks = element_blank(), axis.text.x = element_blank())
print(Plot)
}
#to generate plot of a plot
PlotPlot = function(i,j){
  data = DBH_Yr2_agg %>% filter(SITE == i)%>%filter(PLOT==j)
  t1 = paste("site",i)
  t2 = paste("plot",j)
  Title = paste(t1,t2, sep = " ")
  Plot = ggplot(data = data, aes(x = DBH_class, y = Count)) +
    geom_bar(stat = "identity", col = "black", fill = "green") +
    scale_x_continuous("DBH class",
                       breaks = 1:20,
                       labels = c(1:20),
                       limits = c(0, 20))+
    labs(title = Title)#+
  #theme(axis.ticks = element_blank(), axis.text.x = element_blank())
  print(Plot)
}

#PS not displaing title, not sure why.
```

#Introduction
The purpose of this exploration is to examine the use of the various metrics calculated from the DBH class interval and frequency distribution measurements to generate which correlate with time since disturbance. The successional effect therefore expressed via the metric should correlate with species richness. 

All the dbh data is imported from DBH_live_counts. This is filtered to just look at year 2. Since there are multiple species, each plot has multiple lines per DBH class per plot. These were therefore aggregated, so that this analysis is ignoring species.

The dbh classes in the raw data are recorded in 5cm intervals, class 1 is 5-10cm, class 2 is 5-10cm. 


#Running sum of differences
First, the sum of running differences in count between adjacent DBH classes is trialled. Using this calculation it can be seen that a high frequency of small dbh classes would be the first term in the sum. Subsequent subtractions of smaller values would result in a large positive value. A large positive would then represent an early succussion with lots of young saplings. The reverse would occur for a mature plot and a large negative number would be found.



```{r }
#Get the data , enter input CSV file name here, for data in data directory
inputfile = 'table_DBH_live_counts_71-03.csv'
fullfile = paste("../Data",inputfile, sep = "/")
DBH_measurements = as.tbl(read.csv(fullfile))
```


```{r}
#Just year 2
Yr2_DBH = DBH_measurements %>% filter(Yr == 2)

```


```{r}
# One line per dbh per plot, i.e. ignore species
DBH_Yr2_agg = aggregate(Count~DBH_class + PLOT + SITE, data = Yr2_DBH, sum) 
DBH_Yr2_agg = filter(DBH_Yr2_agg, PLOT !=60)
# Count is now the sum of counts in each DBH class.

```


```{r, echo=FALSE, eval = FALSE}
# This will take a minute - and will give you 103 teeny tiny plots. Each plot is a site #and contains 16 smaller subplots showing frequency distrib of dbh classes in each plot.
#Not very useful because you cant see very much
plot_list = list()
for (i in 1:103) {
  Site = DBH_Yr2_agg %>% filter(SITE == i)
  Plotname = paste("Site", i, sep = "")
  Plot = ggplot(data = Site, aes(x = DBH_class, y = Count)) +
    geom_bar(stat = "identity", col = "black", fill = "green") +
    facet_wrap( ~ PLOT) +
    scale_x_continuous("DBH class",
      breaks = 1:32,
      labels = c(1:32),
      limits = c(0, 32))+
  labs(title = Plotname)
  theme(axis.ticks = element_blank(), axis.text.x = element_blank())
  plot_list[[i]] = Plot
}
#pdf("DBH Plots")
for (i in 1:103) {
  print(plot_list[[i]])
}

```


```{r}

#This code just subtracts, f1 - f2 - f3 - ... - fn, where fi are the counts in each class
DBH_index = function(DBH_counts){
 index = DBH_counts[1]-sum(DBH_counts[-1])
 return(index)
}

indices =  aggregate(Count~PLOT + SITE, data = DBH_Yr2_agg, DBH_index)
#indices are now per plot per site indices
```

Consider site 2 plots 10 and 11

```{r}
PlotSite(2)
```

```{r}
DBH_Yr2_agg %>% filter(SITE == 2) %>% filter (PLOT == 10)

```

```{r}
DBH_Yr2_agg %>% filter(SITE == 2) %>% filter (PLOT == 11)
```


```{r}

Site2_plot10_index = indices%>%filter(SITE == 2)%>%filter(PLOT ==10)
Site2_plot11_index = indices%>%filter(SITE == 2)%>%filter(PLOT ==11)
r = c("Plot10","Plot11")
c = "Site 2"
index_df = as.data.frame(rbind(Site2_plot10_index,Site2_plot11_index))
index_df
```
The first table show the frequency data, the second sow the indices calculated for these two plots (unhelpfullly also displayed as Count)

Plots 10 and 11 have lots of smaller trees, and therefore a similar time since an opening event. But they have indices of - 109 and 37 respectively. Plot 10 site 2 has the most negative index of all the plots, so we would want this number to imply a long time has occured since an opening event, which it does not.

Looking at the counts, plot 10 has 12 in the first category and 69 in the next, therefore the first subtraction gives a relatively large negative value, the remaining values, all being smaller, result in a large negative index.

This shows that the subtraction is not suitable as a metric because it will only work if the are fewer counts in each successive class.


#The mean as a metric


```{r}
# might need a mode function and here's some calculations to create means etc.
Mode = function(x){
 names(table(x))[table(x)==max(table(x))]
}
#some other numbers that might be useful
max_class = DBH_Yr2_agg%>%filter(DBH_class == max(DBH_class)) #=32, but not for many things
highest_freq = DBH_Yr2_agg%>%filter(Count == max(Count)) #=372 in dbh 1 at Site103 plot14
modal_dbh  = Mode(DBH_Yr2_agg%>%select(DBH_class))#1

# get the means of each plot
means = data.frame()
dbh_classes = c(1:32)
dbh_values = seq(from = 7.5, to = 162.5, length = 32)
for (i in 1:103){
  sitedata = DBH_Yr2_agg%>%filter(SITE == i)
  for (j in 1:16) {
    plotdata = sitedata%>%filter(PLOT == j)
    means[i,j] = round(sum(plotdata$Count*(plotdata$DBH_class*5+2.5))/sum(plotdata$Count), digits = 2)
    }
}
rownames(means) = c(1:103)
colnames(means) = c(1:16)
#the Nan a=might be an issue, I think its Ok to replace them with zeros
means = replace(means, is.na(means),0)

```


```{r}

#Might be useful to compare plots which have similar means and see if the dbh distribution looks similar
# The if here needed no Nans in the df, otherwise it stopped at first Nan it came across
# This funtion calculates Site,Plot and means for all sites/plot below the threshold. 
#Then randomly select some to be plotted
GetSites = function(lower, upper){
  m_df = data.frame()
  for (i in 1:103){
    for (j in 1:16){
      if( (means[i,j] < upper) && (means[i,j] > lower) ){
        m_df = rbind(m_df,c(i,j,means[i,j]))
      }}}
  colnames(m_df) = c("Site", "Plot","Mean")
  
  plot_list = list()
 
  if(nrow(m_df) >= 4){
    for (i in 1:4){
    #browser()
    rand = sample(nrow(m_df),4)
    tmp = rand[1]
    rand_row = m_df[tmp,]
    site = rand_row[[1]]
    plot = rand_row[[2]]
    mu = rand_row[[3]]
 
t1 = paste("site",i)
t2 = paste("plot",j)
t3 = paste("mean= ",mu)
Title = paste(t1,t2,t3, sep = " ")
    
  data = DBH_Yr2_agg%>%filter(SITE==site)%>%filter(PLOT==plot)
  Plot = ggplot(data = data, aes(x = DBH_class, y = Count)) +
    geom_bar(stat = "identity",  position="dodge", width = 0.5,col = "black", fill = "green") +
    scale_x_continuous("DBH class", 
                       breaks = 1:32,
                       #labels = c(1:32),
                       limits = c(0,32))+
    labs(title = Title)+
    theme(axis.ticks = element_blank(), axis.text.x = element_blank())
  plot_list[[i]] = Plot
    }
    grid.arrange(grobs = plot_list, ncol = 2)
  }
}

```

Plots of plots with mean less than 10

```{r}
#enter the lower and upper limit of the means in GetSites(lower,upper)
GetSites(0,10)
#You can repeatedly call this chunk to see different random selections of plots
#with means within the range specified
```
For a mean below 10 the graphs demonstrate a pattern consistent with lots of young saplings and arecent opening event. 


```{r}
GetSites(10,15)
```

For means between 10 and 15 the frequency of trees in the next DBH classes increases

```{r}
GetSites(15, 20)
```

```{r}
GetSites(20,25)
```

```{r}
GetSites(25,30)
```

```{r}
GetSites(30,35)
```

With low means, because the mean is in or near the lowest dbh class, the distribution will be right skewed and fit the desired criteria of representing a plot with lots of young trees and few older ones. When we consider larger means there are more distributions that could give that mean, and whether or not they reflect the time since an opening event is less clear. Consider Site 1 plot 16 and Site 3 plot 16.

```{r}
PlotPlot(1,16)
```

```{r}
PlotPlot(3,16)

```


These have similar means, but would we be able to say they represented plots that had similar time since event. Site 1 plot 16 with its righ skew looks to be in an early successional stage, whereas Site 3 plot 16 looks more mature.

The mean may not be a metric that clearly correlates with time since event.

#Symetry index

Lorimer and Krug (1983) suggest that neither the shape parameter of the Weibull distribution notr the coefficient of skewness are very very sensitive to the displacement of the media from mode, and hence are not useful metrics for describing the dbh distribution. They suggest  a symmetry index defined as 

$$ I_{s} = \frac{(mode - X_{l})}{(X_{0.95} - X_{l})}$$
Where $$ X_{l}$$ is the lower threshold diameter and $$ X_{0.95}$$ is the 95th percentile.


