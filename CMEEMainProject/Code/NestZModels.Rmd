---
title: "NestZModels"
output: pdf_document
---

```{r setup, include=FALSE}
knitr::opts_chunk$set(echo = FALSE)
rm(list = ls())
cat("\014")
library(dplyr)
library(ggplot2)
library(visreg)
library(car) #for vif
library(GGally) # for ggpairs
library(gridExtra)
library(tidyr)
library(reshape)
library(energy)
library(corrplot)
library(factoextra)
library(FactoMineR)
```

```{r}
#Get site vars and nest slopes

AllSiteVars = read.csv("../Data/CompleteSiteLevelVars.csv")
nestdata = readRDS("nest_mixed_model_fits.RDS")

#All site vars has some cols we know are not useful, delete these now

colnames(AllSiteVars)
```
```{r}
todelete = c(1,3,4,5,6,7,8,9,11,12,14,23,24,25,26,27,28,29,30)
Sitevars = AllSiteVars[-todelete]
colnames(Sitevars) = c("Site","PHI","Buffer","Num_NVC","sd_pH", "sd_SOM" , "num_MSG","sd_LBA",
                        "sd_meanDBH", "sd_TD", "no_trees","meanDBH" , "meanph" , "meanSOM" , "meanLBA" ,
                       "meanTD", "area_ratio" )
```


```{r}
#take site and slope from nestdata
NestSlope = nestdata[-c(2,4,5)]
#join to SiteData
SitedataZ = inner_join(Sitevars,NestSlope)
SitedataZ[is.na(SitedataZ)] = 0

```
 
```{r message=FALSE, warning=FALSE, paged.print=FALSE}
# first look for response of z to the variables
SitedataZ_vars = as.data.frame(SitedataZ[-1])
melted = melt(SitedataZ_vars, id.vars = "slope")


ggplot(melted, aes(x = value, y = slope))+
  geom_point()+
  geom_smooth(method = loess)+
  facet_wrap(~variable, scales = "free")


 


```

```{r}
as.data.frame(round(apply(SitedataZ_vars[-17],2, function(x) dcor(x,SitedataZ$slope)), digits = 2))
```
The two varibles with the lowest correlation coefficients to slope are number of major soil groups and mean tree density are not strongly correlated to the slope (Corr = 0.12,0.11) The number of major soil groups was included since it might relfect habitat heterogeneity. However, its effect on species richness is not clear here. It may change the species assemblage, but not influence richness. This variable will be removed.

The outliers in PHI make it had to see the reposne of slope to this variable. Therefore these two sites will be removed.

```{r message=FALSE, warning=FALSE, paged.print=FALSE}


SitedataZ_vars = as.data.frame(SitedataZ_vars[-c(6,15)])
outliers = c(78,97)
SitedataZ_vars = SitedataZ_vars%>%filter(PHI != outliers)
melted = melt(SitedataZ_vars, id.vars = "slope")
ggplot(melted, aes(x = value, y = slope))+
  geom_point()+
  geom_smooth(method = loess)+
  facet_wrap(~variable, scales = "free")



```

```{r}
as.data.frame(round(apply(SitedataZ_vars[-15],2, function(x) dcor(x,SitedataZ_vars$slope)), digits = 2))
```


```{r}
ggpairs(SitedataZ_vars[-15], axisLabels="none",
        lower = list(continuous="smooth"),
        diag="blankDiag",
        upper = list(corSize=2,axisLabels='show'))+
theme(legend.position = "none",
      panel.grid.major = element_blank(),
      axis.ticks = element_blank(),
      panel.border = element_rect(linetype = "dashed", colour = "black", fill = NA))

```

```{r}
pc = PCA(SitedataZ_vars[-15], scale.unit = TRUE, ncp = 11, graph = FALSE)
var = get_pca_var(pc)
```

```{r echo=FALSE, message=FALSE, warning=FALSE, paged.print=FALSE}
eig.val_physical = get_eigenvalue(pc)
eig.val_physical
```



```{r eval=FALSE, message=FALSE, warning=FALSE, include=FALSE, paged.print=FALSE}
fviz_eig(pc, addlabels = TRUE, ylim = c(0,30))
```
    
```{r echo=FALSE, message=FALSE, warning=FALSE, paged.print=FALSE}
fviz_pca_var(pc, col.var = "cos2", repel = TRUE)
```


```{r echo=FALSE, message=FALSE, warning=FALSE}

corrplot(var$cos2)
```
There are very strong correlations between meanSOM and sd_SOM (0.821), sd-LBA and meanLBA (0.648), meanDBH and sd_meanDBH, (0.516),
meanDBH and sd_TD, (-0.482), meanLBA and no_trees, (-0.478).

The correlations between standard deviations and means for all the variables suggests that it could be advantagous to split the variables into two sets..PS - what does this correlation imply, is this a common thing? 


